<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="volver()">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Mensajes</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-searchbar
      placeholder="Buscar conversaciones..."
      (ionInput)="buscarConversacion($event)"
      [value]="searchTerm">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Estado vacÃ­o -->
  <div *ngIf="conversacionesFiltradas.length === 0" class="empty-state">
    <ion-icon name="chatbubbles-outline"></ion-icon>
    <h3>No hay conversaciones</h3>
    <p *ngIf="!searchTerm">Contacta a alguien para empezar a chatear</p>
    <p *ngIf="searchTerm">No se encontraron resultados</p>
  </div>

  <!-- Lista de conversaciones -->
  <div class="conversaciones-list">
    <div
      *ngFor="let conversacion of conversacionesFiltradas"
      class="conversacion-card"
      (click)="abrirChat(conversacion)">

      <div class="avatar-container">
        <img
          *ngIf="conversacion.otroUsuario.foto"
          [src]="conversacion.otroUsuario.foto"
          alt="Foto de perfil">
        <div *ngIf="!conversacion.otroUsuario.foto" class="avatar-placeholder">
          <ion-icon name="person"></ion-icon>
        </div>
        <span
          *ngIf="obtenerMensajesNoLeidos(conversacion) > 0"
          class="unread-badge">
          {{ obtenerMensajesNoLeidos(conversacion) }}
        </span>
      </div>

      <div class="conversacion-info">
        <div class="info-header">
          <h3 class="nombre">{{ conversacion.otroUsuario.nombre }}</h3>
          <span class="timestamp">{{ formatearFecha(conversacion.ultimaActualizacion) }}</span>
        </div>

        <div *ngIf="conversacion.articuloRelacionado" class="articulo-tag">
          <ion-icon name="cube-outline"></ion-icon>
          <span>{{ conversacion.articuloRelacionado.nombre }}</span>
        </div>

        <p
          class="ultimo-mensaje"
          [class.no-leido]="obtenerMensajesNoLeidos(conversacion) > 0">
          {{ conversacion.ultimoMensaje || 'Sin mensajes' }}
        </p>
      </div>

      <div class="conversacion-actions">
        <ion-button
          fill="clear"
          size="small"
          (click)="eliminarConversacion($event, conversacion)">
          <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>
