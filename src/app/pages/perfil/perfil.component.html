<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="volver()">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Mi Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Tarjeta de perfil -->
  <div class="perfil-card" *ngIf="usuario">
    <!-- Foto de perfil -->
    <div class="foto-container"
         [class.editable]="editandoPerfil"
         [class.pendiente]="hayFotoPendiente()"
         (click)="editandoPerfil && cambiarFoto()">
      <img
        [src]="obtenerFotoUsuario()"
        alt="Foto de perfil"
        class="foto-perfil"
        (error)="$any($event.target).src = fotoDefault">

      <!-- Overlay cuando est谩 en modo edici贸n -->
      <div
        *ngIf="editandoPerfil && !hayFotoPendiente()"
        class="overlay-editar-foto">
        <ion-icon name="camera"></ion-icon>
        <span>{{ puedeActualizarFoto ? 'Cambiar foto' : 'Cambiar en ' + diasParaFoto + 'd' }}</span>
      </div>

      <!-- Overlay cuando la foto est谩 pendiente de revisi贸n -->
      <div
        *ngIf="hayFotoPendiente()"
        class="overlay-pendiente">
        <ion-icon name="time-outline"></ion-icon>
        <span>En revisi贸n</span>
      </div>

      <!-- Badge cuando la foto fue rechazada -->
      <div
        *ngIf="fotoRechazada()"
        class="badge-rechazada">
        <ion-icon name="close-circle"></ion-icon>
      </div>
    </div>

    <!-- Nombre y calificaci贸n -->
    <h2 class="perfil-nombre">{{ usuario.nombre }}</h2>
    
    <div class="rating">
      <ion-icon 
        *ngFor="let star of obtenerEstrellas()" 
        name="star"
        class="star-filled">
      </ion-icon>
      <ion-icon 
        *ngFor="let i of [1,2,3,4,5].slice(obtenerEstrellas().length)" 
        name="star-outline"
        class="star-empty">
      </ion-icon>
      <span class="rating-value">({{ usuario.calificacion }})</span>
    </div>

    <!-- Insignias -->
    <div class="insignias-container" *ngIf="obtenerInsigniasUsuario().length > 0">
      <div class="insignia" *ngFor="let insignia of obtenerInsigniasUsuario()">
        <span class="insignia-emoji">{{ insignia.emoji }}</span>
        <span class="insignia-nombre">{{ insignia.nombre }}</span>
      </div>
    </div>

    <!-- Secci贸n de Puntos y Recompensas -->
    <div class="puntos-section" *ngIf="estadisticasPuntos">
      <div class="puntos-header">
        <div class="puntos-icono"></div>
        <div class="puntos-info">
          <h3 class="puntos-titulo">Mis Puntos</h3>
          <p class="puntos-saldo">{{ puntosActuales }} puntos</p>
        </div>
      </div>

      <div class="puntos-stats">
        <div class="stat-item">
          <span class="stat-label">Ganados</span>
          <span class="stat-value">+{{ estadisticasPuntos.puntosGanados }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Gastados</span>
          <span class="stat-value">-{{ estadisticasPuntos.puntosGastados }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Vouchers</span>
          <span class="stat-value">{{ estadisticasPuntos.voucherCanjeados }}</span>
        </div>
      </div>

      <div class="puntos-acciones">
        <ion-button expand="block" fill="solid" color="primary" (click)="irARecompensas()">
          <ion-icon name="gift" slot="start"></ion-icon>
          Ver Recompensas
        </ion-button>
      </div>
    </div>

    <!-- Bot贸n editar -->
    <ion-button
      expand="block" 
      fill="outline"
      (click)="toggleEdicion()"
      class="btn-editar">
      <ion-icon name="create" slot="start"></ion-icon>
      {{ editandoPerfil ? 'Cancelar' : 'Editar perfil' }}
    </ion-button>
  </div>

  <!-- Formulario de edici贸n -->
  <div *ngIf="editandoPerfil && usuario" class="edicion-form">
    <form [formGroup]="formularioEdicion">
      <ion-item>
        <ion-label position="floating">Nombre completo</ion-label>
        <ion-input 
          type="text" 
          formControlName="nombre">
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Tel茅fono</ion-label>
        <ion-input 
          type="tel" 
          formControlName="telefono">
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Ciudad</ion-label>
        <ion-input 
          type="text" 
          formControlName="ciudad">
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Biograf铆a</ion-label>
        <ion-textarea 
          formControlName="biografia"
          placeholder="Cu茅ntanos sobre ti (m谩x 200 caracteres)">
        </ion-textarea>
      </ion-item>

      <ion-button 
        expand="block" 
        color="success"
        (click)="guardarCambios()"
        [disabled]="cargando || formularioEdicion.invalid">
        <ion-spinner *ngIf="cargando" name="crescent"></ion-spinner>
        {{ cargando ? 'Guardando...' : 'Guardar cambios' }}
      </ion-button>
    </form>
  </div>

  <!-- Estad铆sticas -->
  <div class="estadisticas">
    <div class="estadistica-card">
      <div class="estadistica-numero">{{ usuario?.trueques_realizados }}</div>
      <div class="estadistica-label">Trueques realizados</div>
    </div>

    <div class="estadistica-card">
      <div class="estadistica-numero">{{ usuario?.trueques_pendientes }}</div>
      <div class="estadistica-label">Pendientes</div>
    </div>

    <div class="estadistica-card">
      <div class="estadistica-numero">{{ usuario?.recompensas }}</div>
      <div class="estadistica-label">Recompensas</div>
    </div>
  </div>

  <!-- Bot贸n Ver Mis Rese帽as -->
  <ion-card class="resenas-card">
    <ion-card-content>
      <button class="menu-button resenas-button" (click)="verMisResenas()">
        <ion-icon name="star"></ion-icon>
        <div class="resenas-info">
          <span class="resenas-titulo">Mis Rese帽as</span>
          <span class="resenas-descripcion">Ver calificaciones y comentarios</span>
        </div>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </button>
    </ion-card-content>
  </ion-card>

  <!-- Informaci贸n personal -->
  <ion-card class="info-card">
    <ion-card-header>
      <ion-card-title>Informaci贸n personal</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="info-row">
        <span class="info-label">Email:</span>
        <span class="info-valor">{{ usuario?.email }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Tel茅fono:</span>
        <span class="info-valor">{{ usuario?.telefono }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Ciudad:</span>
        <span class="info-valor">{{ usuario?.ciudad }}</span>
      </div>
      <div class="info-row" *ngIf="usuario?.biografia">
        <span class="info-label">Biograf铆a:</span>
        <span class="info-valor">{{ usuario?.biografia }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Miembro desde:</span>
        <span class="info-valor">{{ usuario?.fechaRegistro | date: 'dd/MM/yyyy' }}</span>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Nivel de usuario -->
  <ion-card class="recompensas-card">
    <ion-card-content>
      <div class="recompensas-info">
        <div class="recompensa-item">
          <span class="recompensa-icono"></span>
          <div>
            <div class="recompensa-titulo">Nivel de usuario</div>
            <div class="recompensa-descripcion">{{ (usuario?.calificacion || 0) >= 4.5 ? 'Premium' : (usuario?.calificacion || 0) >= 3 ? 'Est谩ndar' : 'B谩sico' }}</div>
          </div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Secci贸n de ayuda -->
  <ion-card class="ayuda-card">
    <ion-card-header>
      <ion-card-title>Ayuda y configuraci贸n</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <button
        *ngIf="!esAdmin()"
        class="menu-button"
        (click)="irATrueques()">
        <ion-icon name="list"></ion-icon>
        <span>Mis trueques</span>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </button>

      <button 
        class="menu-button"
        (click)="reportarProblema()">
        <ion-icon name="alert-circle"></ion-icon>
        <span>Reportar problema</span>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </button>

 
      <button
        class="menu-button"
        routerLink="/terminos">
        <ion-icon name="document-text"></ion-icon>
        <span>T茅rminos y condiciones</span>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </button>

      <button
        *ngIf="esAdmin()"
        class="menu-button admin-button"
        (click)="irAPanelAdmin()">
        <ion-icon name="shield-checkmark"></ion-icon>
        <span>Panel de Administraci贸n</span>
        <ion-badge color="danger">ADMIN</ion-badge>
      </button>

      <button
        class="menu-button logout"
        (click)="logout()">
        <ion-icon name="log-out"></ion-icon>
        <span>Cerrar sesi贸n</span>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </button>
    </ion-card-content>
  </ion-card>
</ion-content>